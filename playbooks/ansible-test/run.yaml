- hosts: all
  tasks:
    - name: Load Ansible collection Galaxy metadata
      ansible.builtin.set_fact:
        ansible_test_galaxy_yml: "{{ lookup('file', [zuul.executor.work_root, zuul.project.src_dir, 'galaxy.yml'] | path_join) | from_yaml }}"

    - name: Get Python version
      ansible.builtin.command:
        cmd: python3 --version
      register: ansible_test_python3_version

    - name: Extract major.minor Python version
      ansible.builtin.set_fact:
        ansible_test_python3_version_short: >-
          {{ ansible_test_python3_version.stdout.split()[1].split('.')[:2] | join('.') }}

    - name: Run "ansible-test"
      ansible.builtin.command:
        cmd: uv run ansible-test units --python {{ ansible_test_python3_version_short }}
      args:
        chdir: "{{ ansible_env.HOME }}/.ansible/collections/ansible_collections/{{ ansible_test_galaxy_yml.namespace }}/{{ ansible_test_galaxy_yml.name }}"
